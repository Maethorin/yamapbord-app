<div class="container-fluid backlog">
  <div class="row">
  <h4>Sprints</h4>
  <div class="sprint-container col-md-4" ng-repeat="sprint in sprints">
    <div class="panel panel-default panel-show-sprint">
      <div class="panel-heading" ng-click="selectSprintToEdit($event, sprint, $index, 'sprint')">
        <i class="fa btn-open" ng-class="{'fa-chevron-down': !sprint.opened, 'fa-chevron-up': sprint.opened}" ng-click="toggleOpenSprintPanel($event, sprint)"></i>
        <span class="sprint-team">[{{sprint.team.name}}]</span>
        <span class="sprint-name" title="{{sprint.name}}" ng-bind="sprint.name|limitWithEllipsis:47"></span>
        <span class="sprint-status" ng-class="sprint.statusSlug" ng-bind="sprint.status[0]"></span>
        <button class="btn btn-primary btn-sm btn-save-sprint" ng-click="selectSprintToEdit($event, sprint, $index, 'sprint')"><i class="fa" ng-class="{'fa-edit': sprint.isPlanned, 'fa-eye': !sprint.isPlanned}"></i></button>
      </div>
      <div class="panel-body as-list" ng-class="{'as-list': !sprint.opened}">
        <h4>Dates</h4>
        <div class="sprint-dates">
          <span class="start-date">Starts: <span class="date" ng-bind="sprint.startDate"></span></span>
          <div class="working-days">
            <span class="label">working days</span>
            <i class="fa fa-long-arrow-left"></i><span class="number" ng-bind="sprint.workingDays"></span><i class="fa fa-long-arrow-right"></i>
          </div>
          <span class="end-date">Ends: <span class="date" ng-bind="sprint.endDate"></span></span>
        </div>
        <h4>Objective</h4>
        <div class="sprint-objective" ng-scrollable>
          <p ng-bind="sprint.objective"></p>
        </div>
        <h4 class="story-header">
          <span class="title">Stories</span>
          <span class="sprint-point"><span class="value" ng-bind="sprint.points|numberOrText"></span>points</span>
        </h4>
        <ul class="list-group sprint-stories" ng-scrollable="scrollOptions">
          <li class="list-group-item" ng-repeat="story in sprint.stories" title="{{story.statement}}" ng-click="toggleShowStoryPopup(story)">
            <span class="story-type-name" ng-class="story.type | lowercase" title="{{story.typeName}}"></span>
            <span class="story-name" ng-bind="story.name|limitWithEllipsis:35"></span>
            <span class="badge points-{{story.points|numberOrText:'null'}}" ng-bind="story.points|numberOrText"></span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  </div>

  <div class="row">
  <h4>Kanbans</h4>
  <div class="sprint-container col-md-4" ng-repeat="kanban in kanbans">
    <div class="panel panel-default panel-show-sprint">
      <div class="panel-heading" ng-click="selectSprintToEdit($event, kanban, $index, 'kanban')">
        <i class="fa btn-open" ng-class="{'fa-chevron-down': !kanban.opened, 'fa-chevron-up': kanban.opened}" ng-click="toggleOpenSprintPanel($event, kanban)"></i>
        <span class="sprint-team">[{{kanban.team.name}}]</span>
        <span class="sprint-name" title="{{kanban.name}}" ng-bind="kanban.name|limitWithEllipsis:40"></span>
        <button class="btn btn-primary btn-sm btn-save-sprint" ng-click="selectSprintToEdit($event, kanban, $index, 'kanban')"><i class="fa fa-edit"></i></button>
      </div>
      <div class="panel-body as-list" ng-class="{'as-list': !kanban.opened}">
        <h4 class="story-header">
          <span class="title">Stories</span>
          <span class="sprint-point"><span class="value" ng-bind="kanban.points|numberOrText"></span>points</span>
        </h4>
        <ul class="list-group sprint-stories" ng-scrollable="scrollOptions">
          <li class="list-group-item" ng-repeat="story in kanban.stories" title="{{story.statement}}" ng-click="toggleShowStoryPopup(story)">
            <span class="story-type-name" ng-class="story.type | lowercase" title="{{story.typeName}}"></span>
            <span class="story-name" ng-bind="story.name|limitWithEllipsis:35"></span>
            <span class="badge points-{{story.points|numberOrText:'null'}}" ng-bind="story.points|numberOrText"></span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  </div>

  <form name="formSprint" novalidate ng-submit="saveSelectedSprint(formSprint)">
    <div class="popup-complete-sprint" ng-class="{'opened': completeSprintPopupOpened}" ng-if="selectedSprint !== null">
      <div class="panel panel-default panel-edit-{{selectedSprint.type}}">
        <div class="panel-heading" title="{{selectedSprint.statement}}">
          <div class="col-md-2 sprint-team">
            <label>Team:</label>
            <div class="form-group">
              <select id="selectTeam" ng-model="selectedSprint.team" ng-disabled="!selectedSprint.isPlanned" required class="select-team form-control" ng-options="team.name for team in teams track by team.id">
                <option value="">-- choose --</option>
              </select>
            </div>
          </div>
          <div class="col-md-10">
            <label>Name:</label> <input class="sprint-name" ng-model="selectedSprint.name" ng-disabled="!selectedSprint.isPlanned"/>
          </div>
        </div>
        <div class="panel-body">
          <section ng-if="selectedSprint.type === 'sprint'">
            <h4>Dates</h4>
            <div class="dropdown start date">
              <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                <datetimepicker ng-model="selectedSprint.startDate"
                                datetimepicker-config="{dropdownSelector: '#dropdownStartDate', renderOn: 'end-date-changed', minView:'day'}"
                                on-set-time="startDateOnSetTime()"
                                data-before-render="startDateBeforeRender($dates)"/>
              </ul>
            </div>
            <div class="dropdown end date">
              <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                <datetimepicker ng-model="selectedSprint.endDate"
                                datetimepicker-config="{dropdownSelector: '#dropdownEndDate', renderOn: 'start-date-changed', minView:'day'}"
                                data-on-set-time="endDateOnSetTime()"
                                data-before-render="endDateBeforeRender($view, $dates, $leftDate, $upDate, $rightDate)"/>
              </ul>
            </div>

            <div class="sprint-dates">
              <div class="start-date">
                <label for="inputStartDate">Starts:</label>
                <a class="date dropdown-toggle" id="dropdownStartDate" role="button" data-toggle="dropdown" data-target=".dropdown.start.date">
                  <div class="input-group">
                    <input type="text" id="inputStartDate" class="form-control" name="startDate" ng-model="selectedSprint.startDate" date-time-input="YYYY-MM-DD" ng-disabled="!selectedSprint.isPlanned" required/>
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                  </div>
                </a>
                <div class="disable-mask" ng-if="!selectedSprint.isPlanned"></div>
              </div>

              <div class="working-days">
                <span class="label">working days</span>
                <i class="fa fa-long-arrow-left"></i><span class="number" ng-bind="selectedSprint.workingDays"></span><i class="fa fa-long-arrow-right"></i>
              </div>

              <div class="end-date">
                <label for="inputEndDate">Starts:</label>
                <a class="date dropdown-toggle" id="dropdownEndDate" role="button" data-toggle="dropdown" data-target=".dropdown.end.date">
                  <div class="input-group">
                    <input type="text" id="inputEndDate" class="form-control" name="endDate" ng-model="selectedSprint.endDate" date-time-input="YYYY-MM-DD" ng-disabled="!selectedSprint.isPlanned" required/>
                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                  </div>
                </a>
                <div class="disable-mask" ng-if="!selectedSprint.isPlanned"></div>
              </div>
            </div>

            <h4>Objective</h4>
            <div class="sprint-objective">
              <textarea rows="2" ng-model="selectedSprint.objective" required ng-disabled="!selectedSprint.isPlanned"></textarea>
            </div>
          </section>
          <h4 class="story-header">
            <span class="title">Stories</span>
            <button type="button" ng-if="selectedSprint.isPlanned && selectedSprint.id" class="btn btn-primary btn-sm btn-create-story" ng-click="addNewStoryToSelectedSprint('kanban')"><i class="fa fa-plus"></i>Create New Story</button>
            <span class="sprint-point"><span class="value" ng-bind="selectedSprint.points|numberOrText"></span>points</span>
          </h4>
          <ul class="list-group sprint-stories" ng-scrollable="scrollOptions">
            <li class="list-group-item" ng-repeat="story in selectedSprint.stories" ng-click="selectStoryToEdit($event, story, $index)">
              <span class="story-type-name" ng-class="story.type | lowercase" title="{{story.typeName}}"></span>
              <span class="story-name" ng-bind="story.name|limitWithEllipsis:20" title="{{story.name}}"></span>
              <span class="story-statement" title="{{story.statement}}" ng-bind="story.statement|limitWithEllipsis:120"></span>
              <button type="button" class="btn btn-default btn-xs btn-remove-item" ng-if="selectedSprint.isPlanned" ng-click="removeSprintStory(story, $index, $event)"><i class="fa fa-trash"></i></button>
              <span class="badge points-{{story.points|numberOrText:'null'}}" ng-bind="story.points|numberOrText"></span>
            </li>
            <li class="new-item list-group-item" ng-click="addingStoryToSelectedSprint()" ng-if="selectedSprint.isPlanned">
              <span ng-show="!newStoryVisible">Add a story</span>
            </li>
          </ul>
        </div>
        <div class="panel-footer">
          <button type="button" class="btn btn-danger" ng-click="cancelSaveSelectedSprint()"><i class="fa fa-close"></i> {{selectedSprint.isPlanned ? 'Cancel' : 'Close'}}</button>
          <button type="submit" class="btn btn-success" ng-if="selectedSprint.isPlanned"><i class="fa fa-save"></i> Save</button>
        </div>
      </div>
    </div>
  </form>

  <div class="popup-stories" ng-class="{'opened': storiesPopupOpened}">
    <div class="panel panel-default panel-stories">
      <div class="panel-heading">
        IceLog Stories
        <input type="text" ng-model="searchStories" class="search-stories form-control" placeholder="Search...">
      </div>
      <div class="panel-body">
        <ul class="list-group sprint-stories" ng-scrollable="scrollOptions">
          <li class="list-group-item" ng-repeat="story in stories|filter:searchStories" title="{{story.statement}}" ng-click="toggleShowStoryPopup(story)">
            <checkbox ng-class="{'btn-primary': story.selected}" ng-click="$event.stopPropagation()" ng-model="story.selected"></checkbox>
            <span class="story-type-name" ng-class="story.type|lowercase" title="{{story.typeName}}"></span>
            <span class="story-name" ng-bind="story.name|limitWithEllipsis:12" title="{{story.name}}"></span>
            <span class="story-statement" title="{{story.statement}}" ng-bind="story.statement|limitWithEllipsis:88"></span>
            <span class="badge points-{{story.points|numberOrText:'null'}}" ng-bind="story.points|numberOrText"></span>
          </li>
        </ul>
      </div>
      <div class="panel-footer">
        <button type="button" class="btn btn-danger" ng-click="cancelAddSelectedSprintStories()">Cancel</button>
        <button type="button" class="btn btn-success" ng-click="saveAddSelectedSprintStories()">OK</button>
      </div>
    </div>
  </div>

  <div class="popup-complete-story" ng-class="{'opened': showStoryPopupOpened}">
    <div class="panel panel-default panel-complete-story">
      <div class="panel-heading" title="{{showinStory.statement}}">
        <span class="story-type-name" ng-class="showinStory.type | lowercase " title="{{showinStory.typeName}}" ng-bind="showinStory.typeName"></span>
        <span class="story-name">{{showinStory.name}}</span>
        <span class="story-status" ng-class="showinStory.status | lowercase" ng-bind="showinStory.statusName"></span>
        <span class="badge points-{{showinStory.points|numberOrText:'null'}}" ng-bind="showinStory.points|numberOrText"></span>
      </div>
      <div class="panel-body">
        <div class="story-statement" ng-bind="showinStory.statement"></div>
        <uib-tabset active="activeJustified" justified="true">
          <uib-tab index="0" heading="Tasks" select="changeScroll()">
            <ul class="list-group story-tasks" ng-scrollable>
              <li class="list-group-item" ng-repeat="task in showinStory.tasks">
                {{ task.task }}
              </li>
            </ul>
          </uib-tab>
          <uib-tab index="1" heading="DoD" select="changeScroll()">
            <ul class="list-group story-definitions" ng-scrollable>
              <li class="list-group-item" ng-repeat="definition in showinStory.definitionOfDone">
                {{ definition.definition }}
              </li>
            </ul>
          </uib-tab>
        </uib-tabset>
      </div>
      <div class="panel-footer">
        <button type="button" class="btn btn-primary" ng-click="toggleShowStoryPopup(null)">Close</button>
      </div>
    </div>
  </div>

  <section id="createStory" ng-include="'templates/include/story-form.html'"></section>

  <div class="filter-bar" ng-class="{'expanded': filterBarExpanded}">
    <div class="filter-trigger" ng-click="toggleFilterBarExpanded()">
      <div></div><div></div>
    </div>
    <div class="filter-content">
      <div class="col-md-2">
        <h4>Type: <span ng-bind="filter.type.name"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('type', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li class="list-group-item {{type.code | lowercase}}" ng-class="{'selected': type.code === filter.type.code}" ng-repeat="type in storyTypes" ng-bind="type.name" ng-click="selectFilter('type', type)"></li>
          </ul>
        </div>
      </div>
      <div class="col-md-1">
        <h4>VP: <span ng-bind="filter.valuePoint"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('valuePoint', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li class="list-group-item" ng-class="{'selected': 'N' === filter.valuePoint}" ng-click="selectFilter('valuePoint', 'N')">N</li>
            <li class="list-group-item" ng-class="{'selected': valuePoint === filter.valuePoint}" ng-repeat="valuePoint in points" ng-bind="valuePoint" ng-click="selectFilter('valuePoint', valuePoint)"></li>
          </ul>
        </div>
      </div>
      <div class="col-md-1">
        <h4>SP: <span ng-bind="filter.point"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('point', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li class="list-group-item" ng-class="{'selected': 'N' === filter.point}" ng-click="selectFilter('point', 'N')">N</li>
            <li class="list-group-item" ng-class="{'selected': point === filter.point}" ng-repeat="point in points" ng-bind="point" ng-click="selectFilter('point', point)"></li>
          </ul>
        </div>
      </div>
      <div class="col-md-3">
        <h4>Module: <span ng-bind="filter.module.name|limitWithEllipsis:25"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('module', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li class="list-group-item" ng-class="{'selected': module.id === filter.module.id}" ng-repeat="module in modules" ng-bind="module.name" ng-click="selectFilter('module', module)"></li>
          </ul>
        </div>
      </div>
      <div class="col-md-3">
        <h4>Epic: <span ng-bind="filter.epic.name|limitWithEllipsis:25"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('epic', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li ng-if="filter.module !== null && filter.module.epics.length > 0" class="list-group-item" ng-class="{'selected': epic.id === filter.epic.id}" ng-repeat="epic in filter.module.epics|orderBy:'name'" ng-click="selectFilter('epic', epic)">
              {{epic.modules ? '[{modules}] {name}'.format(epic) : epic.name}}
            </li>
            <li ng-if="filter.module === null || filter.module.epics.length === 0" class="list-group-item" ng-class="{'selected': epic.id === filter.epic.id}" ng-repeat="epic in epics|orderBy:['modules', 'name']" ng-click="selectFilter('epic', epic)">
              {{epic.modules ? '[{modules}] {name}'.format(epic) : epic.name}}
            </li>
          </ul>
        </div>
      </div>
      <div class="col-md-2">
        <h4>Requester: <span ng-bind="filter.requester.name|limitWithEllipsis:17"></span><button type="button" class="btn btn-xs btn-danger btn-clear-filter" ng-click="selectFilter('requester', null)">clear</button></h4>
        <div class="filter-bar-list">
          <ul class="list-group">
            <li class="list-group-item" ng-class="{'selected': requester.id === filter.requester.id}" ng-repeat="requester in requesters" ng-bind="requester.name" ng-click="selectFilter('requester', requester)"></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
